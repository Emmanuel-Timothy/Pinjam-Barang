<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Browsing - PinjamBarang</title>
<link rel="stylesheet" href="assets/css/style.css">
<!-- Add Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
.category-list {
  display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;
}
.category-item {
  border: 1px solid #ccc; border-radius: 10px; padding: 10px;
  width: 120px; text-align: center; cursor: pointer;
  transition: all 0.3s ease;
}
.category-item:hover { background-color: #f0f0f0; transform: scale(1.05); }
.category-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-bottom: 5px; }

.search-container {
  display: flex; gap: 10px; margin: 15px 0;
}
.search-container input {
  flex: 1; padding: 8px 10px; border-radius: 6px; border: 1px solid #ccc;
}
.search-container button {
  padding: 8px 12px; border: none; background-color: #333; color: white;
  border-radius: 6px; cursor: pointer;
}
.search-container button:hover { background-color: #555; }

.product-list {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-top: 15px;
  justify-content: flex-start;
  align-items: flex-start;
}
.product-card {
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 10px;
  text-align: center;
  background-color: white;
  transition: 0.3s;
  width: 180px;
  min-width: 180px;
  max-width: 180px;
  height: 400px;
  min-height: 400px;
  max-height: 400px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  margin-bottom: 15px;
  box-sizing: border-box;
}
.product-card img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 8px;
}
.price { color: #009933; font-weight: 600; }
/* Map modal styles */
#locModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999; }
#locModal .modal-inner { background:white; padding:12px; border-radius:8px; max-width:720px; width:95%; box-sizing:border-box; }
#mapSelect { height:360px; width:100%; border-radius:6px; margin-bottom:8px; }
.loc-controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.loc-controls input[type="range"] { flex:1; }
.loc-info { font-size:13px; color:#333; }
.loc-apply { background:#007bff;color:#fff;padding:7px 12px;border-radius:6px;border:none;cursor:pointer; }
.loc-close { background:#ccc;color:#000;padding:7px 12px;border-radius:6px;border:none;cursor:pointer; }
</style>
</head>
<body>

<nav class="navbar">
  <div class="logo"><img src="assets/img/LogoBW.png" alt="Logo" style="width:140px;height:55px;border-radius:6px;object-fit:cover"></div>
  <div class="menu-toggle" onclick="toggleMenu()">
    <span></span>
    <span></span>
    <span></span>
  </div>
  <div class="nav-links" id="navLinks">
    <a href="index.html">Home</a>
    <a href="browsing.html" class="active">Browsing</a>
    <a href="tentang.html">Tentang Kami</a>
    <a href="chat.html">Chat</a>
    <a href="login.html" class="login-btn">Log In / Sign In</a>
    <a href="pinjam.html" class="cart-link">
      <img src="assets/img/cart.png" alt="Cart" style="width:25px;vertical-align:middle;">
      <span class="cart-badge" id="cartCount">0</span>
    </a>
  </div>
</nav>

<script>
function toggleMenu() {
  const navLinks = document.getElementById('navLinks');
  navLinks.classList.toggle('active');
}
</script>

<div class="container" style="margin-top:20px;max-width:900px">
  <h2>Jelajahi Barang</h2>
  
  <div class="category-list">
    <div class="category-item" onclick="filterCategory('Elektronik')">
      <img src="assets/img/Icon Electronic.png" alt="Elektronik" onerror="this.src='assets/img/PH.png'">
      <p>Elektronik</p>
    </div>
    <div class="category-item" onclick="filterCategory('Peralatan')">
      <img src="assets/img/Icon Handyman‚Äôs Tools.png" alt="Peralatan" onerror="this.src='assets/img/PH.png'">
      <p>Peralatan</p>
    </div>
    <div class="category-item" onclick="filterCategory('Hobi')">
      <img src="assets/img/Icon Sport.png" alt="Olahraga" onerror="this.src='assets/img/PH.png'">
      <p>Hobi</p>
    </div>
    <div class="category-item" onclick="filterCategory('Furnitur')">
      <img src="assets/img/Icon Furnitures.png" alt="Furnitur" onerror="this.src='assets/img/PH.png'">
      <p>Furnitur</p>
    </div>
  </div>

  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Cari barang...">
    <button onclick="searchProduct()">Cari üîç</button>
    <button onclick="showAll()">Jelajahi Semua Barang</button>
   <!-- new: open location modal -->
   <button onclick="openLocationModal()">Pilih Lokasi üìç</button>
  </div>

  <div class="product-list" id="productList"></div>
</div>

<footer class="footer">
  ¬© PinjamBarang ‚Äî Prototype ‚Ä¢ dibuat untuk demo
</footer>

<script>
// === Product Data ===
const products = [
  { name: "Proyektor", category: "Elektronik", price: 100000, img: "assets/img/Projector.png" },
  { name: "Kamera", category: "Elektronik", price: 80000, img: "assets/img/Kamera.png" },
  { name: "Set Berkebun", category: "Peralatan", price: 25000, img: "assets/img/Gardening.png" },
  { name: "Mesin Jahit", category: "Peralatan", price: 35000, img: "assets/img/Jahit.png" },
  { name: "Tenda Camping", category: "Hobi", price: 60000, img: "assets/img/Tenda.png" },
  { name: "Set Padel", category: "Hobi", price: 40000, img: "assets/img/Padel.png" },
  { name: "Ranjang Bayi", category: "Furnitur", price: 45000, img: "assets/img/BC.png" },
  { name: "Biola", category: "Hobi", price: 75000, img: "assets/img/Biola.png" },
  { name: "Cello", category: "Hobi", price: 120000, img: "assets/img/Cello.png" },
  { name: "Gitar Elektrik", category: "Hobi", price: 90000, img: "assets/img/Gitar Elektrik.png" },
  { name: "Teleskop", category: "Hobi", price: 110000, img: "assets/img/Teleskop.png" },
  { name: "Air Fryer", category: "Elektronik", price: 50000, img: "assets/img/Air Fyer.png" },
  { name: "Griller", category: "Elektronik", price: 45000, img: "assets/img/Griller.png" },
  { name: "Oven", category: "Elektronik", price: 70000, img: "assets/img/Oven.png" },
  { name: "Kipas Angin", category: "Elektronik", price: 20000, img: "assets/img/Kipas Angin.png" },
  { name: "Printer", category: "Elektronik", price: 60000, img: "assets/img/Printer.png" },
  { name: "DJ Controller", category: "Hobi", price: 130000, img: "assets/img/DJ Controller.png" },
  { name: "Set Alat Golf", category: "Hobi", price: 150000, img: "assets/img/Set Alat Golf.png" }
];

// === Display Products ===
function displayProducts(list) {
  const container = document.getElementById("productList");
  container.innerHTML = "";
  if (list.length === 0) {
    container.innerHTML = "<p style='text-align:center'>Tidak ada barang ditemukan.</p>";
    return;
  }
    const inv = getInventory();
    const bookings = getBookings();
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    list.forEach(p => {
      const stock = inv[p.name] !== undefined ? inv[p.name] : defaultStock;
      // Calculate booked for today
      const bookedToday = (bookings[p.name] && bookings[p.name][todayStr]) || 0;
      const availableToday = Math.max(0, stock - bookedToday);
      const outOfStock = availableToday <= 0;
      container.innerHTML += `
        <div class="product-card">
          <img src="${p.img}" alt="${p.name}" onclick="goToDetail('${p.name}')">
          <h4>${p.name}</h4>
          <p><small>${p.category}</small></p>
          <p class="price">Rp ${p.price.toLocaleString()}</p>
          <p style="margin:4px 0;font-weight:600;font-size:15px;color:${outOfStock ? '#c00' : '#009933'}">
            ${outOfStock ? 'Stok Habis' : `Tersedia bulan ini: ${availableToday}`}
          </p>
          <button class="btn btn-primary" onclick="addToCart('${p.name}')" ${outOfStock ? 'disabled style=\"background:#aaa;cursor:not-allowed\"' : ''}>+ Keranjang</button>
        </div>
      `;
    });
  };

// === Category & Search ===
function filterCategory(cat) {
  const filtered = products.filter(p => p.category === cat);
  displayProducts(filtered);
}

function searchProduct() {
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const filtered = products.filter(p => p.name.toLowerCase().includes(keyword));
  displayProducts(filtered);
}

function showAll() {
  document.getElementById("searchInput").value = "";
  displayProducts(products);
}


// === Inventory Logic ===
// Simulate inventory: each product has a stock (default 5)
const defaultStock = 5;
function getInventory() {
  return JSON.parse(localStorage.getItem("inventory") || "{}")
}
function setInventory(inv) {
  localStorage.setItem("inventory", JSON.stringify(inv));
}
// Always reset inventory to demo values on page load (for demo/testing)
const inv = {
  "Proyektor HD": 3,
  "Kamera DSLR": 2,
  "Set Berkebun": 5,
  "Mesin Jahit": 4,
  "Tenda Camping": 6,
  "Meja Belajar": 4,
  "Kursi Kantor": 3
};
setInventory(inv);

// Track bookings per product per date
function getBookings() {
  return JSON.parse(localStorage.getItem("bookings") || "{}")
}
function setBookings(b) {
  localStorage.setItem("bookings", JSON.stringify(b));
}

let selectedItem = null;
let availableQty = defaultStock;

function addToCart(name) {
  selectedItem = products.find(p => p.name === name);
  if (!selectedItem) return;
  document.getElementById("rentItemName").textContent = selectedItem.name;
  document.getElementById("rentStart").value = "";
  document.getElementById("rentEnd").value = "";
  document.getElementById("rentQty").value = 1;
  document.getElementById("rentQty").disabled = false;
  document.getElementById("rentStart").disabled = false;
  document.getElementById("rentEnd").disabled = false;
  document.getElementById("rentModalAddBtn").disabled = false;
  document.getElementById("rentAvailable").textContent = "";
  document.getElementById("rentModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("rentModal").style.display = "none";
}

// Validate quantity based on available stock
function validateQuantity() {
  const qtyInput = document.getElementById("rentQty");
  const qty = parseInt(qtyInput.value);
  if (qty > availableQty) {
    qtyInput.value = availableQty;
  }
  if (qty < 1) {
    qtyInput.value = 1;
  }
}

// Helper: get all dates between two dates (inclusive)
function getDateRange(start, end) {
  const arr = [];
  let dt = new Date(start);
  while (dt <= end) {
    arr.push(dt.toISOString().split('T')[0]);
    dt.setDate(dt.getDate() + 1);
  }
  return arr;
}

// Check available qty for selected item and date range
function checkAvailableQty() {
  const start = document.getElementById("rentStart").value;
  const end = document.getElementById("rentEnd").value;
  if (!selectedItem || !start || !end) {
    document.getElementById("rentAvailable").textContent = "";
    document.getElementById("rentModalAddBtn").disabled = true;
    return;
  }
  const startDate = new Date(start);
  const endDate = new Date(end);
  const today = new Date();
  today.setHours(0,0,0,0);
  const maxDate = new Date(today);
  maxDate.setMonth(maxDate.getMonth() + 1);
  if (startDate < today || endDate > maxDate || startDate >= endDate) {
    document.getElementById("rentAvailable").textContent = "Tanggal harus dalam 1 bulan ke depan dan valid.";
    document.getElementById("rentModalAddBtn").disabled = true;
    return;
  }
  const inv = getInventory();
  const bookings = getBookings();
  const stock = inv[selectedItem.name] || defaultStock;
  const range = getDateRange(startDate, endDate);
  let minAvail = stock;
  range.forEach(date => {
    const b = (bookings[selectedItem.name] && bookings[selectedItem.name][date]) || 0;
    if (stock - b < minAvail) minAvail = stock - b;
  });
  availableQty = minAvail;
  document.getElementById("rentAvailable").textContent = `Tersedia: ${minAvail} unit pada tanggal dipilih`;
  document.getElementById("rentModalAddBtn").disabled = minAvail <= 0;
}

document.addEventListener("DOMContentLoaded", function() {
  document.getElementById("rentStart").addEventListener("change", checkAvailableQty);
  document.getElementById("rentEnd").addEventListener("change", checkAvailableQty);
});

function confirmRent() {
  const qty = parseInt(document.getElementById("rentQty").value);
  const startDate = new Date(document.getElementById("rentStart").value);
  const endDate = new Date(document.getElementById("rentEnd").value);
  const today = new Date();
  today.setHours(0,0,0,0);
  const maxDate = new Date(today);
  maxDate.setMonth(maxDate.getMonth() + 1);
  if (isNaN(qty) || qty <= 0) return alert("Jumlah harus valid!");
  if (!startDate || !endDate || startDate >= endDate || startDate < today || endDate > maxDate) return alert("Tanggal harus dalam 1 bulan ke depan dan valid!");
  if (qty > availableQty) return alert("Stok tidak cukup untuk tanggal tersebut!");
  const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
  const total = selectedItem.price * qty * days;
  const cartItem = {
    name: selectedItem.name,
    price: selectedItem.price,
    qty: qty,
    days: days,
    total: total,
    start: startDate.toISOString().split('T')[0],
    end: endDate.toISOString().split('T')[0]
  };
  // Update bookings
  const bookings = getBookings();
  const range = getDateRange(startDate, endDate);
  if (!bookings[selectedItem.name]) bookings[selectedItem.name] = {};
  range.forEach(date => {
    bookings[selectedItem.name][date] = (bookings[selectedItem.name][date] || 0) + qty;
  });
  setBookings(bookings);
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
  cart.push(cartItem);
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCartCount();
  closeModal();
  alert(`${selectedItem.name} (${qty}x, ${days} hari) ditambahkan ke keranjang ‚úÖ`);
}
function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem("cart") || "[]");
  document.getElementById("cartCount").textContent = cart.length;
}

// === Detail Redirect ===
function goToDetail(name) {
  window.location.href = `detail.html?item=${encodeURIComponent(name)}`;
}

// === Init ===
window.onload = () => {
  showAll();
  updateCartCount();
};
</script>
<!-- Rent Modal -->
<div id="rentModal" style="display:none; 
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
  <div style="background:white;padding:20px;border-radius:10px;max-width:350px;width:90%;text-align:center;">
    <h3>Sewa Barang</h3>
    <p id="rentItemName"></p>
    <label>Jumlah Barang:</label><br>
  <input type="number" id="rentQty" min="1" max="99" onchange="validateQuantity()" style="width:80%;margin:5px 0;padding:5px;"><br>
  <span id="rentAvailable" style="display:block;margin-bottom:5px;color:#009933;font-weight:600"></span>
  <label>Tanggal Mulai:</label><br>
  <input type="date" id="rentStart" style="width:80%;margin:5px 0;padding:5px;"><br>
  <label>Tanggal Selesai:</label><br>
  <input type="date" id="rentEnd" style="width:80%;margin:5px 0;padding:5px;"><br>
  <button id="rentModalAddBtn" onclick="confirmRent()" style="background:#28a745;color:white;padding:8px 15px;border:none;border-radius:6px;margin-top:10px;cursor:pointer;">Tambahkan ke Keranjang</button>
  <button onclick="closeModal()" style="background:#ccc;color:black;padding:8px 15px;border:none;border-radius:6px;margin-top:10px;cursor:pointer;">Batal</button>
  </div>
</div>

<!-- Location Modal -->
<div id="locModal">
  <div class="modal-inner">
    <h3>Pilih Lokasi dan Radius</h3>
    <div id="mapSelect"></div>
    <div class="loc-controls">
      <label style="white-space:nowrap">Radius:</label>
      <!-- fixed 5km: slider disabled and set to 5000 -->
      <input type="range" id="radiusRange" min="5000" max="5000" step="500" value="5000" disabled>
      <div class="loc-info" id="radiusLabel">5.0 km</div>
      <div style="flex:1"></div>
      <button class="loc-apply" onclick="applyLocation()">Terapkan</button>
      <button class="loc-close" onclick="closeLocationModal()">Tutup</button>
    </div>
    <div style="margin-top:8px;font-size:13px;color:#555">
      Titik pusat: <span id="locCoords">-</span>
    </div>
  </div>
</div>

<!-- Add Leaflet JS and map handling script -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // location/map state
  let locMap, centerMarker, circleLayer, handleMarker;
  let currentRadius = 5000; // meters fixed at 5 km
  // Default center (Fredericton NB from image) - changeable
  const defaultCenter = [-7.8015608, 110.364571];

  function openLocationModal() {
    document.getElementById('locModal').style.display = 'flex';
    setTimeout(() => { initLocationMap(); }, 100); // slight delay to ensure modal visible
  }

  function closeLocationModal() {
    document.getElementById('locModal').style.display = 'none';
  }

  function initLocationMap() {
    if (!locMap) {
      locMap = L.map('mapSelect').setView(defaultCenter, 8);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(locMap);

      // create center marker
      centerMarker = L.marker(defaultCenter, { draggable: true }).addTo(locMap);
      centerMarker.on('drag', onCenterMoved);
      centerMarker.on('move', onCenterMoved);

      // create circle
      circleLayer = L.circle(defaultCenter, { radius: currentRadius, color: '#007bff', fillOpacity: 0.06 }).addTo(locMap);

      // create handle marker on circumference (east) - NOT draggable because radius is fixed
      const handlePos = destinationPoint(defaultCenter[0], defaultCenter[1], currentRadius, 90);
      handleMarker = L.marker(handlePos, { draggable: false, opacity: 0.9 }).addTo(locMap);

      // update UI
      updateLocUI();
      locMap.invalidateSize();
    } else {
      // map already created: just update view & layers
      locMap.invalidateSize();
      const stored = JSON.parse(localStorage.getItem('selectedLocation') || 'null');
      if (stored) {
        centerMarker.setLatLng([stored.lat, stored.lng]);
        currentRadius = stored.radius || currentRadius;
      }
      circleLayer.setLatLng(centerMarker.getLatLng()).setRadius(currentRadius);
      moveHandleFromRadius();
      updateLocUI();
    }

    // if saved selection exists, use it
    const saved = JSON.parse(localStorage.getItem('selectedLocation') || 'null');
    if (saved) {
      centerMarker.setLatLng([saved.lat, saved.lng]);
      currentRadius = saved.radius || currentRadius;
      circleLayer.setLatLng(centerMarker.getLatLng()).setRadius(currentRadius);
      moveHandleFromRadius();
      updateLocUI();
      locMap.setView(centerMarker.getLatLng(), locMap.getZoom());
    }
  }

  function onCenterMoved() {
    const c = centerMarker.getLatLng();
    circleLayer.setLatLng(c);
    moveHandleFromRadius();
    updateLocUI();
  }

  function moveHandleFromRadius() {
    const c = centerMarker.getLatLng();
    const dest = destinationPoint(c.lat, c.lng, currentRadius, 90); // east
    handleMarker.setLatLng(dest);
  }

  function updateLocUI() {
    const c = centerMarker.getLatLng();
    // always show 5.0 km (currentRadius == 5000)
    document.getElementById('radiusLabel').textContent = `${(currentRadius/1000).toFixed(1)} km`;
    document.getElementById('locCoords').textContent = `${c.lat.toFixed(6)}, ${c.lng.toFixed(6)}`;
    document.getElementById('radiusRange').value = currentRadius;
  }

  function applyLocation() {
    const c = centerMarker.getLatLng();
    const selection = { lat: c.lat, lng: c.lng, radius: currentRadius };
    localStorage.setItem('selectedLocation', JSON.stringify(selection));
    closeLocationModal();
    // You can call a filter function here to refresh product list based on selection.
    alert(`Lokasi disimpan: ${selection.lat.toFixed(5)}, ${selection.lng.toFixed(5)} ‚Ä¢ Radius ${(selection.radius/1000).toFixed(1)} km`);
  }

  // simple destination point (lat, lon, distance in meters, bearing degrees)
  // returns [lat, lon]
  function destinationPoint(lat, lon, distance, bearing) {
    const R = 6378137; // Earth radius in meters (WGS-84)
    const Œ¥ = distance / R; // angular distance in radians
    const Œ∏ = bearing * Math.PI / 180;
    const œÜ1 = lat * Math.PI / 180;
    const Œª1 = lon * Math.PI / 180;

    const œÜ2 = Math.asin(Math.sin(œÜ1) * Math.cos(Œ¥) + Math.cos(œÜ1) * Math.sin(Œ¥) * Math.cos(Œ∏));
    const Œª2 = Œª1 + Math.atan2(Math.sin(Œ∏) * Math.sin(Œ¥) * Math.cos(œÜ1), Math.cos(Œ¥) - Math.sin(œÜ1) * Math.sin(œÜ2));

    return [œÜ2 * 180 / Math.PI, (Œª2 * 180 / Math.PI)];
  }

  // Expose functions to global scope used by markup
  window.openLocationModal = openLocationModal;
  window.closeLocationModal = closeLocationModal;
  window.applyLocation = applyLocation;
</script>

</body>
</html>
