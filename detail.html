<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Detail Barang - PinjamBarang</title>
<link rel="stylesheet" href="assets/css/style.css">
<style>
.detail-container {
  max-width: 800px;
  margin: 40px auto;
  padding: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
.detail-container img {
  width: 300px;
  height: 220px;
  object-fit: cover;
  border-radius: 10px;
}
.detail-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.detail-info h2 { margin: 0; }
.detail-info p { margin: 6px 0; }
.price { font-size: 20px; font-weight: bold; color: #007a33; }
.btn { margin-top: 10px; padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; }
.btn-primary { background: #007a33; color: white; }
.btn-primary:hover { background: #005f27; }
.btn-outline { background: white; border: 1px solid #007a33; color: #007a33; }
.btn-outline:hover { background: #007a33; color: white; }
</style>
</head>
<body>

<nav class="navbar">
  <div class="logo"><img src="assets/img/LogoBW.png" alt="Logo" style="width:140px;height:55px;border-radius:6px;object-fit:cover"></div>
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="browsing.html">Browsing</a>
    <a href="tentang.html">Tentang Kami</a>
    <a href="chat.html">Chat</a>
    <a href="login.html" class="login-btn">Log In / Sign In</a>
    <a href="pinjam.html" class="cart-link">
      <img src="assets/img/cart.png" alt="Cart" style="width:25px;vertical-align:middle;">
      <span class="cart-badge" id="cartCount">0</span>
    </a>
  </div>
</nav>

<div class="detail-container" id="detailContainer">
  <p>Memuat data barang...</p>
</div>

<div style="text-align:center;margin:20px">
  <a href="browsing.html" class="btn btn-outline">‚Üê Kembali ke Browsing</a>
</div>

<footer class="footer">
  ¬© PinjamBarang ‚Äî Prototype ‚Ä¢ dibuat untuk demo
</footer>

<!-- Rent Modal -->
<div id="rentModal" style="display:none; 
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000;">
  <div style="background:white;padding:20px;border-radius:10px;max-width:350px;width:90%;text-align:center;">
    <h3>Sewa Barang</h3>
    <p id="rentItemName"></p>
    <label>Jumlah Barang:</label><br>
    <input type="number" id="rentQty" min="1" value="1" style="width:80%;margin:5px 0;padding:5px;"><br>
    
    <label>Tanggal Mulai:</label><br>
    <input type="date" id="rentStart" style="width:80%;margin:5px 0;padding:5px;"><br>
    
    <label>Tanggal Selesai:</label><br>
    <input type="date" id="rentEnd" style="width:80%;margin:5px 0;padding:5px;"><br>

    <button onclick="confirmRent()" style="background:#28a745;color:white;padding:8px 15px;border:none;border-radius:6px;margin-top:10px;cursor:pointer;">Tambahkan ke Keranjang</button>
    <button onclick="closeModal()" style="background:#ccc;color:black;padding:8px 15px;border:none;border-radius:6px;margin-top:10px;cursor:pointer;">Batal</button>
  </div>
</div>

<script>
// Product data (same as browsing.html)
const products = [
  { name: "Kamera Canon", category: "Elektronik", price: 50000, img: "assets/img/PH.png", desc: "Kamera DSLR Canon dengan kualitas foto profesional." },
  { name: "Laptop ASUS", category: "Elektronik", price: 100000, img: "assets/img/PH.png", desc: "Laptop ASUS berkinerja tinggi, cocok untuk kerja dan hiburan." },
  { name: "Obeng Set", category: "Peralatan", price: 15000, img: "assets/img/PH.png", desc: "Set obeng lengkap berbagai ukuran untuk keperluan rumah." },
  { name: "Tangga Lipat", category: "Peralatan", price: 25000, img: "assets/img/PH.png", desc: "Tangga lipat aluminium ringan dan kokoh." },
  { name: "Sepeda Gunung", category: "Olahraga", price: 75000, img: "assets/img/PH.png", desc: "Sepeda gunung dengan suspensi ganda dan rem cakram." },
  { name: "Meja Belajar", category: "Furnitur", price: 40000, img: "assets/img/PH.png", desc: "Meja belajar minimalis dengan desain modern." },
  { name: "Kursi Kantor", category: "Furnitur", price: 45000, img: "assets/img/PH.png", desc: "Kursi kantor ergonomis untuk kenyamanan maksimal." },
  { name: "Tenda Camping", category: "Lainnya", price: 60000, img: "assets/img/PH.png", desc: "Tenda berkapasitas 4 orang, tahan air dan mudah dipasang." },
];

// === Parse Query ===
const params = new URLSearchParams(window.location.search);
const itemName = params.get("item");

let selectedItem = null;

// === Inventory Logic (same as browsing.html) ===
const defaultStock = 5;
const initialStock = {
  "Kamera Canon": 2,
  "Laptop ASUS": 0,
  "Obeng Set": 8,
  "Tangga Lipat": 4,
  "Sepeda Gunung": 1,
  "Meja Belajar": 6,
  "Kursi Kantor": 3,
  "Tenda Camping": 5
};
function getInventory() {
  return JSON.parse(localStorage.getItem("inventory") || "{}")
}
function setInventory(inv) {
  localStorage.setItem("inventory", JSON.stringify(inv));
}
// Always reset inventory for demo
setInventory(initialStock);
function getBookings() {
  return JSON.parse(localStorage.getItem("bookings") || "{}")
}
function setBookings(b) {
  localStorage.setItem("bookings", JSON.stringify(b));
}
// Helper: get all dates between two dates (inclusive)
function getDateRange(start, end) {
  const arr = [];
  let dt = new Date(start);
  while (dt <= end) {
    arr.push(dt.toISOString().split('T')[0]);
    dt.setDate(dt.getDate() + 1);
  }
  return arr;
}

// === Display Item ===
function showDetail() {
  const product = products.find(p => p.name === itemName);
  const container = document.getElementById("detailContainer");
  if (!product) {
    container.innerHTML = "<p>Barang tidak ditemukan.</p>";
    return;
  }
  // Calculate available today
  const inv = getInventory();
  const bookings = getBookings();
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];
  const stock = inv[product.name] !== undefined ? inv[product.name] : defaultStock;
  const bookedToday = (bookings[product.name] && bookings[product.name][todayStr]) || 0;
  const availableToday = Math.max(0, stock - bookedToday);
  const outOfStock = availableToday <= 0;
  container.innerHTML = `
    <img src="${product.img}" alt="${product.name}">
    <div class="detail-info">
      <h2>${product.name}</h2>
      <p><strong>Kategori:</strong> ${product.category}</p>
      <p class="price">Rp ${product.price.toLocaleString()} / hari</p>
      <p>${product.desc}</p>
      <p style="margin:4px 0;font-weight:600;color:${outOfStock ? '#c00' : '#009933'}">
        ${outOfStock ? 'Stok Habis hari ini' : `Tersedia hari ini: ${availableToday}`}
      </p>
      <button class="btn btn-primary" onclick="addToCart('${product.name}')" ${outOfStock ? 'disabled style=\"background:#aaa;cursor:not-allowed\"' : ''}>Tambah ke Keranjang üõí</button>
    </div>
  `;
}

// === Cart Logic with Modal ===
let availableQty = defaultStock;
function addToCart(name) {
  selectedItem = products.find(p => p.name === name);
  if (!selectedItem) return;
  document.getElementById("rentItemName").textContent = selectedItem.name;
  document.getElementById("rentStart").value = "";
  document.getElementById("rentEnd").value = "";
  document.getElementById("rentQty").value = 1;
  document.getElementById("rentQty").disabled = false;
  document.getElementById("rentStart").disabled = false;
  document.getElementById("rentEnd").disabled = false;
  // Add or show available info
  if (!document.getElementById("rentAvailable")) {
    const qtyInput = document.getElementById("rentQty");
    const span = document.createElement("span");
    span.id = "rentAvailable";
    span.style.display = "block";
    span.style.marginBottom = "5px";
    span.style.color = "#009933";
    span.style.fontWeight = "600";
    qtyInput.parentNode.insertBefore(span, qtyInput.nextSibling);
  }
  document.getElementById("rentAvailable").textContent = "";
  document.getElementById("rentModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("rentModal").style.display = "none";
}

function confirmRent() {
  const qty = parseInt(document.getElementById("rentQty").value);
  const startDate = new Date(document.getElementById("rentStart").value);
  const endDate = new Date(document.getElementById("rentEnd").value);
  const today = new Date();
  today.setHours(0,0,0,0);
  const maxDate = new Date(today);
  maxDate.setMonth(maxDate.getMonth() + 1);
  if (isNaN(qty) || qty <= 0) return alert("Jumlah harus valid!");
  if (!startDate || !endDate || startDate >= endDate || startDate < today || endDate > maxDate) return alert("Tanggal harus dalam 1 bulan ke depan dan valid!");
  // Check available for all dates
  const inv = getInventory();
  const bookings = getBookings();
  const stock = inv[selectedItem.name] !== undefined ? inv[selectedItem.name] : defaultStock;
  const range = getDateRange(startDate, endDate);
  let minAvail = stock;
  range.forEach(date => {
    const b = (bookings[selectedItem.name] && bookings[selectedItem.name][date]) || 0;
    if (stock - b < minAvail) minAvail = stock - b;
  });
  availableQty = minAvail;
  if (qty > availableQty) return alert("Stok tidak cukup untuk tanggal tersebut!");
  const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
  const total = selectedItem.price * qty * days;
  const cartItem = {
    name: selectedItem.name,
    price: selectedItem.price,
    qty: qty,
    days: days,
    total: total,
    start: startDate.toISOString().split('T')[0],
    end: endDate.toISOString().split('T')[0]
  };
  // Update bookings
  if (!bookings[selectedItem.name]) bookings[selectedItem.name] = {};
  range.forEach(date => {
    bookings[selectedItem.name][date] = (bookings[selectedItem.name][date] || 0) + qty;
  });
  setBookings(bookings);
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
  cart.push(cartItem);
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCartCount();
  closeModal();
  alert(`${selectedItem.name} (${qty}x, ${days} hari) ditambahkan ke keranjang ‚úÖ`);
}

function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem("cart") || "[]");
  document.getElementById("cartCount").textContent = cart.length;
}

// === Init ===
// Set min/max for rentStart and rentEnd to only allow 1 month from today
function setDateLimits() {
  const today = new Date();
  const minDate = today.toISOString().split('T')[0];
  const maxDateObj = new Date(today);
  maxDateObj.setMonth(maxDateObj.getMonth() + 1);
  const maxDate = maxDateObj.toISOString().split('T')[0];
  document.getElementById('rentStart').setAttribute('min', minDate);
  document.getElementById('rentStart').setAttribute('max', maxDate);
  document.getElementById('rentEnd').setAttribute('min', minDate);
  document.getElementById('rentEnd').setAttribute('max', maxDate);
}
document.addEventListener('DOMContentLoaded', setDateLimits);

// === Check available qty for selected date range in modal ===
function checkAvailableQty() {
  const start = document.getElementById("rentStart").value;
  const end = document.getElementById("rentEnd").value;
  if (!selectedItem || !start || !end) {
    document.getElementById("rentAvailable").textContent = "";
    return;
  }
  const startDate = new Date(start);
  const endDate = new Date(end);
  const today = new Date();
  today.setHours(0,0,0,0);
  const maxDate = new Date(today);
  maxDate.setMonth(maxDate.getMonth() + 1);
  if (startDate < today || endDate > maxDate || startDate >= endDate) {
    document.getElementById("rentAvailable").textContent = "Tanggal harus dalam 1 bulan ke depan dan valid.";
    return;
  }
  const inv = getInventory();
  const bookings = getBookings();
  const stock = inv[selectedItem.name] !== undefined ? inv[selectedItem.name] : defaultStock;
  const range = getDateRange(startDate, endDate);
  let minAvail = stock;
  range.forEach(date => {
    const b = (bookings[selectedItem.name] && bookings[selectedItem.name][date]) || 0;
    if (stock - b < minAvail) minAvail = stock - b;
  });
  availableQty = minAvail;
  document.getElementById("rentAvailable").textContent = `Tersedia: ${minAvail} unit pada tanggal dipilih`;
}

document.addEventListener("DOMContentLoaded", function() {
  const rentStart = document.getElementById("rentStart");
  const rentEnd = document.getElementById("rentEnd");
  if (rentStart && rentEnd) {
    rentStart.addEventListener("change", checkAvailableQty);
    rentEnd.addEventListener("change", checkAvailableQty);
  }
});

window.onload = () => {
  showDetail();
  updateCartCount();
};
</script>

</body>
</html>