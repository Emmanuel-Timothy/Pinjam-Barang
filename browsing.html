<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Browsing - PinjamBarang</title>
<link rel="stylesheet" href="assets/css/style.css">
<style>
.category-list {
  display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;
}
.category-item {
  border: 1px solid #ccc; border-radius: 10px; padding: 10px;
  width: 120px; text-align: center; cursor: pointer;
  transition: all 0.3s ease;
}
.category-item:hover { background-color: #f0f0f0; transform: scale(1.05); }
.category-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-bottom: 5px; }

.search-container {
  display: flex; gap: 10px; margin: 15px 0;
}
.search-container input {
  flex: 1; padding: 8px 10px; border-radius: 6px; border: 1px solid #ccc;
}
.search-container button {
  padding: 8px 12px; border: none; background-color: #333; color: white;
  border-radius: 6px; cursor: pointer;
}
.search-container button:hover { background-color: #555; }

.product-list {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-top: 15px;
  justify-content: flex-start;
  align-items: flex-start;
}
.product-card {
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 10px;
  text-align: center;
  background-color: white;
  transition: 0.3s;
  width: 180px;
  min-width: 180px;
  max-width: 180px;
  height: 300px;
  min-height: 300px;
  max-height: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  margin-bottom: 15px;
  box-sizing: border-box;
}
.product-card img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 8px;
}
.price { color: #009933; font-weight: 600; }
</style>
</head>
<body>

<nav class="navbar">
  <div class="logo"><img src="assets/img/LogoBW.png" alt="Logo" style="width:140px;height:55px;border-radius:6px;object-fit:cover"></div>
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="browsing.html" class="active">Browsing</a>
    <a href="tentang.html">Tentang Kami</a>
    <a href="chat.html">Chat</a>
    <a href="login.html" class="login-btn">Log In / Sign In</a>
    <a href="pinjam.html" class="cart-link">
      <img src="assets/img/cart.png" alt="Cart" style="width:25px;vertical-align:middle;">
      <span class="cart-badge" id="cartCount">0</span>
    </a>
  </div>
</nav>

<div class="container" style="margin-top:20px;max-width:900px">
  <h2>Jelajahi Barang</h2>
  
  <div class="category-list">
    <div class="category-item" onclick="filterCategory('Elektronik')">
      <img src="assets/img/PH.png" alt="Elektronik">
      <p>Elektronik</p>
    </div>
    <div class="category-item" onclick="filterCategory('Peralatan')">
      <img src="assets/img/PH.png" alt="Peralatan">
      <p>Peralatan</p>
    </div>
    <div class="category-item" onclick="filterCategory('Olahraga')">
      <img src="assets/img/PH.png" alt="Olahraga">
      <p>Olahraga</p>
    </div>
    <div class="category-item" onclick="filterCategory('Furnitur')">
      <img src="assets/img/PH.png" alt="Furnitur">
      <p>Furnitur</p>
    </div>
    <div class="category-item" onclick="filterCategory('Lainnya')">
      <img src="assets/img/PH.png" alt="Lainnya">
      <p>Lainnya</p>
    </div>
  </div>

  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Cari barang...">
    <button onclick="searchProduct()">Cari üîç</button>
    <button onclick="showAll()">Jelajahi Semua Barang</button>
  </div>

  <div class="product-list" id="productList"></div>
</div>

<footer class="footer">
  ¬© PinjamBarang ‚Äî Prototype ‚Ä¢ dibuat untuk demo
</footer>

<script>
// === Product Data ===
const products = [
  { name: "Kamera Canon", category: "Elektronik", price: 50000, img: "assets/img/PH.png" },
  { name: "Laptop ASUS", category: "Elektronik", price: 100000, img: "assets/img/PH.png" },
  { name: "Obeng Set", category: "Peralatan", price: 15000, img: "assets/img/PH.png" },
  { name: "Tangga Lipat", category: "Peralatan", price: 25000, img: "assets/img/PH.png" },
  { name: "Sepeda Gunung", category: "Olahraga", price: 75000, img: "assets/img/PH.png" },
  { name: "Meja Belajar", category: "Furnitur", price: 40000, img: "assets/img/PH.png" },
  { name: "Kursi Kantor", category: "Furnitur", price: 45000, img: "assets/img/PH.png" },
  { name: "Tenda Camping", category: "Lainnya", price: 60000, img: "assets/img/PH.png" },
];

// === Display Products ===
function displayProducts(list) {
  const container = document.getElementById("productList");
  container.innerHTML = "";
  if (list.length === 0) {
    container.innerHTML = "<p style='text-align:center'>Tidak ada barang ditemukan.</p>";
    return;
  }
    const inv = getInventory();
    const bookings = getBookings();
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    list.forEach(p => {
      const stock = inv[p.name] !== undefined ? inv[p.name] : defaultStock;
      // Calculate booked for today
      const bookedToday = (bookings[p.name] && bookings[p.name][todayStr]) || 0;
      const availableToday = Math.max(0, stock - bookedToday);
      const outOfStock = availableToday <= 0;
      container.innerHTML += `
        <div class="product-card">
          <img src="${p.img}" alt="${p.name}" onclick="goToDetail('${p.name}')">
          <h4>${p.name}</h4>
          <p><small>${p.category}</small></p>
          <p class="price">Rp ${p.price.toLocaleString()}</p>
          <p style="margin:4px 0;font-weight:600;color:${outOfStock ? '#c00' : '#009933'}">
            ${outOfStock ? 'Stok Habis' : `Tersedia bulan ini: ${availableToday}`}
          </p>
          <button class="btn btn-primary" onclick="addToCart('${p.name}')" ${outOfStock ? 'disabled style=\"background:#aaa;cursor:not-allowed\"' : ''}>+ Keranjang</button>
        </div>
      `;
    });
  };

// === Category & Search ===
function filterCategory(cat) {
  const filtered = products.filter(p => p.category === cat);
  displayProducts(filtered);
}

function searchProduct() {
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const filtered = products.filter(p => p.name.toLowerCase().includes(keyword));
  displayProducts(filtered);
}

function showAll() {
  document.getElementById("searchInput").value = "";
  displayProducts(products);
}


// === Inventory Logic ===
// Simulate inventory: each product has a stock (default 5)
const defaultStock = 5;
function getInventory() {
  return JSON.parse(localStorage.getItem("inventory") || "{}")
}
function setInventory(inv) {
  localStorage.setItem("inventory", JSON.stringify(inv));
}
// Always reset inventory to demo values on page load (for demo/testing)
const inv = {
  "Kamera Canon": 2,
  "Laptop ASUS": 0, // out of stock
  "Obeng Set": 8,
  "Tangga Lipat": 4,
  "Sepeda Gunung": 1,
  "Meja Belajar": 6,
  "Kursi Kantor": 3,
  "Tenda Camping": 5
};
setInventory(inv);

// Track bookings per product per date
function getBookings() {
  return JSON.parse(localStorage.getItem("bookings") || "{}")
}
function setBookings(b) {
  localStorage.setItem("bookings", JSON.stringify(b));
}

let selectedItem = null;
let availableQty = defaultStock;

function addToCart(name) {
  selectedItem = products.find(p => p.name === name);
  if (!selectedItem) return;
  document.getElementById("rentItemName").textContent = selectedItem.name;
  document.getElementById("rentStart").value = "";
  document.getElementById("rentEnd").value = "";
  document.getElementById("rentQty").value = 1;
  document.getElementById("rentQty").disabled = false;
  document.getElementById("rentStart").disabled = false;
  document.getElementById("rentEnd").disabled = false;
  document.getElementById("rentModalAddBtn").disabled = false;
  document.getElementById("rentAvailable").textContent = "";
  document.getElementById("rentModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("rentModal").style.display = "none";
}

// Helper: get all dates between two dates (inclusive)
function getDateRange(start, end) {
  const arr = [];
  let dt = new Date(start);
  while (dt <= end) {
    arr.push(dt.toISOString().split('T')[0]);
    dt.setDate(dt.getDate() + 1);
  }
  return arr;
}

// Check available qty for selected item and date range
function checkAvailableQty() {
  const start = document.getElementById("rentStart").value;
  const end = document.getElementById("rentEnd").value;
  if (!selectedItem || !start || !end) {
    document.getElementById("rentAvailable").textContent = "";
    document.getElementById("rentModalAddBtn").disabled = true;
    return;
  }
  const startDate = new Date(start);
  const endDate = new Date(end);
  const today = new Date();
  today.setHours(0,0,0,0);
  const maxDate = new Date(today);
  maxDate.setMonth(maxDate.getMonth() + 1);
  if (startDate < today || endDate > maxDate || startDate >= endDate) {
    document.getElementById("rentAvailable").textContent = "Tanggal harus dalam 1 bulan ke depan dan valid.";
    document.getElementById("rentModalAddBtn").disabled = true;
    return;
  }
  const inv = getInventory();
  const bookings = getBookings();
  const stock = inv[selectedItem.name] || defaultStock;
  const range = getDateRange(startDate, endDate);
  let minAvail = stock;
  range.forEach(date => {
    const b = (bookings[selectedItem.name] && bookings[selectedItem.name][date]) || 0;
    if (stock - b < minAvail) minAvail = stock - b;
  });
  availableQty = minAvail;
  document.getElementById("rentAvailable").textContent = `Tersedia: ${minAvail} unit pada tanggal dipilih`;
  document.getElementById("rentModalAddBtn").disabled = minAvail <= 0;
}

document.addEventListener("DOMContentLoaded", function() {
  document.getElementById("rentStart").addEventListener("change", checkAvailableQty);
  document.getElementById("rentEnd").addEventListener("change", checkAvailableQty);
});

function confirmRent() {
  const qty = parseInt(document.getElementById("rentQty").value);
  const startDate = new Date(document.getElementById("rentStart").value);
  const endDate = new Date(document.getElementById("rentEnd").value);
  const today = new Date();
  today.setHours(0,0,0,0);
  const maxDate = new Date(today);
  maxDate.setMonth(maxDate.getMonth() + 1);
  if (isNaN(qty) || qty <= 0) return alert("Jumlah harus valid!");
  if (!startDate || !endDate || startDate >= endDate || startDate < today || endDate > maxDate) return alert("Tanggal harus dalam 1 bulan ke depan dan valid!");
  if (qty > availableQty) return alert("Stok tidak cukup untuk tanggal tersebut!");
  const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
  const total = selectedItem.price * qty * days;
  const cartItem = {
    name: selectedItem.name,
    price: selectedItem.price,
    qty: qty,
    days: days,
    total: total,
    start: startDate.toISOString().split('T')[0],
    end: endDate.toISOString().split('T')[0]
  };
  // Update bookings
  const bookings = getBookings();
  const range = getDateRange(startDate, endDate);
  if (!bookings[selectedItem.name]) bookings[selectedItem.name] = {};
  range.forEach(date => {
    bookings[selectedItem.name][date] = (bookings[selectedItem.name][date] || 0) + qty;
  });
  setBookings(bookings);
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
  cart.push(cartItem);
  localStorage.setItem("cart", JSON.stringify(cart));
  updateCartCount();
  closeModal();
  alert(`${selectedItem.name} (${qty}x, ${days} hari) ditambahkan ke keranjang ‚úÖ`);
}
function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem("cart") || "[]");
  document.getElementById("cartCount").textContent = cart.length;
}

// === Detail Redirect ===
function goToDetail(name) {
  window.location.href = `detail.html?item=${encodeURIComponent(name)}`;
}

// === Init ===
window.onload = () => {
  showAll();
  updateCartCount();
};
</script>
<!-- Rent Modal -->
<div id="rentModal" style="display:none; 
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
  <div style="background:white;padding:20px;border-radius:10px;max-width:350px;width:90%;text-align:center;">
    <h3>Sewa Barang</h3>
    <p id="rentItemName"></p>
    <label>Jumlah Barang:</label><br>
  <input type="number" id="rentQty" min="1" value="1" style="width:80%;margin:5px 0;padding:5px;"><br>
  <span id="rentAvailable" style="display:block;margin-bottom:5px;color:#009933;font-weight:600"></span>
  <label>Tanggal Mulai:</label><br>
  <input type="date" id="rentStart" style="width:80%;margin:5px 0;padding:5px;"><br>
  <label>Tanggal Selesai:</label><br>
  <input type="date" id="rentEnd" style="width:80%;margin:5px 0;padding:5px;"><br>
  <button id="rentModalAddBtn" onclick="confirmRent()" style="background:#28a745;color:white;padding:8px 15px;border:none;border-radius:6px;margin-top:10px;cursor:pointer;">Tambahkan ke Keranjang</button>
  <button onclick="closeModal()" style="background:#ccc;color:black;padding:8px 15px;border:none;border-radius:6px;margin-top:10px;cursor:pointer;">Batal</button>
  </div>
</div>

<script>
// Set min/max for rentStart and rentEnd to only allow 1 month from today
function setDateLimits() {
  const today = new Date();
  const minDate = today.toISOString().split('T')[0];
  const maxDateObj = new Date(today);
  maxDateObj.setMonth(maxDateObj.getMonth() + 1);
  const maxDate = maxDateObj.toISOString().split('T')[0];
  document.getElementById('rentStart').setAttribute('min', minDate);
  document.getElementById('rentStart').setAttribute('max', maxDate);
  document.getElementById('rentEnd').setAttribute('min', minDate);
  document.getElementById('rentEnd').setAttribute('max', maxDate);
}
document.addEventListener('DOMContentLoaded', setDateLimits);
</script>

</body>
</html>
